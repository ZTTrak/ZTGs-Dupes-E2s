@name RLC Sapphire Beta 4.65
@inputs LoadTest Start Brakerin MU_Master Pod:entity EmBrake UsingRearSeat Hep_On:number [Trucks FrontPlugIn RearPlugIn RLCSHCoolingarrayin]:array  
@outputs Loadtestrunning Startupdraw MainRes OPS Drain2 Drain1 RealTemp On AP LNumber:string RR:string Reverser DynaNotch Notch RealNotch Brake Dynamicsruning MPH KPH Feet V DynaClag Clag ClagOn ClagString:string LocoBrakePressure Emergency AB16M_Notch LB16M_Notch AB26L LB26L [FrontPlugOut RearPlugOut]:array RLCSHCom1:array CarCount WheelSlip Sanding Unlocked Load [BrakeInfo RLCSHBrakeInfo RLCSHLights RLCSHNumberPlates RLCSHTrucks RLCSHCoolingarrayout]:array
@persist [Idles Behavior]:array [Transition Startup Shutdown]:string  IdlePitch Notch TargetNotch SQ On NQ TQ [UpDelays DownDelays]:array StartupClagStart RealTemp StartupClagDuration ClagLevel5
@persist [DynoOn DynoOff Lever_ReverserF Lever_ReverserN Lever_ReverserB Lever_Throttle Lever_16M Lever_26L]:string ClagString:string IdlePitch2 IdlePitch3 IdlePitch4 IdlePitch5 Sander CarCount2
@persist Loadtestrunning LoadTest RevQ DynaQ ServerSideTickRate2 ServerSideTickRate E:entity Starting Dynamics Dynamicsruning DynamicsEnable DNQ Version:string ClagOn LowidlePitch ClagLevel6 NumCompressors
@persist [Controls Routing]:table Alternate:string Handbrakeout Loco:string LNumber:string OPS DecreaseThrottle3 ASOFF [CutomRRname Letters]:string Minnumber Maxnumber
@persist Horsepower PT2speedreadings TE_Starting W:entity Gearing:string GR Point:vector Letter2:string EGPClock:wirelink Load Loadlevel ClagLevel3 Slipping IDLEup LowidleTimer Allow_TC_overload AllowTempSystem
@persist AirBrakeType StartupTime ShutdownTime LocoBrakePressure AB16M_Notch LB16M_Notch ABQ [WheelSound BrakeScreech]:string WQ BQ EMQ BPQ CarCount Threshold_Hard Locked LBQ
@persist [AirBrakeApply AirBrakeRelease Lever_LocoBrake LocoBrakeRelease EmergencyBrakeSound]:string THQ IHQ TE  Fueladdclaglength Compressorallow Clagalowed Soldotsmegasound Clagtimer
@persist MaxLocoBrakeForce DecreaseThrottle4 IncreaseThrottle4 StepDynaNotch MaxTrainBrakeForce BrakeMul HBQ Lever_HandBrake:string MU_OffsetPitch CarCount_Init O:entity ControlPrintOrder:array
@persist WheelSlipProb ETC [SanderOn SanderOff WheelSlipSound1 WheelSlipSound2]:string SandQ Sanding WSQ WSC Bell ClagLevel2 ClagLevel1 Fueladdclag IDLEdown Compstarttime Clagrunonstarttime
@persist Trig2 Force2 RSRN OldNotch DPM DPM_Delay DPM_Pitch DPMH:entity DPMS:string HEP AP ClagLevel4 RealNotch2 ASON  CompRealnotch4 Stroke Idleuptime Idledowntime Customlabeling
@persist [CompressorOn CompressorOff]:string ER Compressing MaxER AB26L LB26L LB26L_ClickQ BlendedBraking BlendQ InfiniteAir TRR2 TRR CompRealnotch2 CompRealnotch3 RLCSHCom1:array [CompressorRunning0 CompressorRunning1 CompressorRunning2 CompressorRunning3 CompressorRunning4 CompressorRunning5 CompressorRunning6 CompressorRunning7 CompressorRunning8]:string
@persist MainRes EqualRes BrakeLine BrakeCyl Switching NumPoints S:string I CompRealnotch ShaftDriven RR:string Letter:string [Shutdown1 Shutdown2 CompressorStartGE CompressorStartEMD CompressorRunning CompressorStop]:string
@persist FuelSaver Time Notch4Warming IncreaseThrottle2 DecreaseThrottle2 Warming InThrottle2 [IdleDown IdleUp LowIdle]:string LowIdling Mode3Q SaverQ ExtendedDynamics SplitShutDowns CFG_HourOffset SecondIncrement FuelSaverNew MinuteIncrement HourIncrement SoundNotch AS Compressortype ASrunning
@trigger Start 
@model models/cheeze/beta/white_button.mdl

if(first()|dupefinished()){
    
    Version="4.65" # Dont's of the touch

    Allow_TC_overload=1 #set to 1 to bypass the TC cut Brakerin system
    AllowTempSystem=1 #set to 1 if no fans or proper RLC SH fans are connected to the chip 
    
   
    ServerSideTickRate=1 #[ This Makes the sound transistions Smoother on certan servers with odd ball tickrates
    0 = 30 Odball Tickrate for Servrers Running On Non-GUI Unix, Example TS200, LuzRail, BlueTick,
    1 = 33 Tickrate(Most Common) Servers Such as FC&N use this
    2 = 66 Tickrate Most ACF Servers Use This and some Really Half Ass Trainbuild servers
    3 = 128 Tickrate because fuck it, CSGO / PVP type servers use this. (HIGHLY NOT RECOMENDED)]#
    
  PT2speedreadings=1 #set to one for PT2 speed reading
    

    Dev=0  # don't touch please
    


    #[
        Welcome to RLC Sapphire edit to RLC Platinum V.1.42 by AlphaGibbon43 (Tyler), Based on Magnum's RLC Platinum V.1.42
        Installation is about the Same as RLCPT v.1.42 you'll figure it out
        All Credit to Magnum For the coding Provided, 

        
    Chat Commands:
    
        .engine - Toggles the Engine.
        .reverser <N> - Changes the Reverser.
        .notch <N> - Changes the engine Notch.
        .brake <N> - Changes the Trainline Brake Pressure. If no argument, applies the Emergency Brake.
        .dynamics <N> - Engages/Disengages the Dynamic Brakes.
        .handbrake - Applies the Handbrake, which gives a rubber physprop to all cars in the consist.
        .controls - Prints the controls to your chat.
        .superice - "super ices" the entire train (Note: actually uses "friction_00").
        .count - Prints the total number of connected cars, assuming 3-prop cars.
        
    Miscellaneous Notes:
    
        The MU System is backwards compatible with RLC, RLC AB, RLC PT, RLC TI, but note the braking code is still a little fucked, I need time to work on that.
        This RLC version is not Recomended to be used on other units that aren't LRI based, RLC Saphire or (RLC SH) has dependency issues and won't like other installs other then what there built on now
        Final note, RLC Sappire is not done. matter of fact it's far from it, i will take bug reports but do not expect help from me to install this on your units, I've given you plenty of warning listed above. 
         
    ]#
     local LocomotiveType = "ALCO RS3" #The Locomotive model designation, for naming purposes.
    local EngineType = "Alco 244v12" #The Engine model, for naming purposes.
    
    Horsepower = 1600 #Horsepower, Please don't make this Excessive
    TE_Starting = 55000 #Starting Tractive effort, in lbf. NOTE: YOU NEED TO DOUBLE THIS COMPARED TO RLCPT OR ELSE YOUR UNIT WILL SLUG UP TO SPEED.
 
    #///////////////////////

    


    DynamicsEnable =0  #0 for No Dynamic Braking 
                       #1 For Engine Speed Run Up By Dynamic Braking Load (OLD EMD Style)
                       #2 idle by Dynanotch (Newer GE)
                       #3 for Notch 4 (ALCO) brakeing
                       #4 for Blended Dynamic Braking (Modern passenger)
                                     
    ExtendedDynamics=0  
    
    DynoOn=" "
    DynoOff=" "
    
    
    ETC = 0 #Electronic Traction Control setting. 0 for no ETC (Hard), 1 for ETC (Easy), 2 to Disable Wheelslip entirely (Lazy).
    
    AS = 0 # Auto Sander 1 For auto sanding on Slip, 0 For no Auto Sand on slip
    
    
    AirBrakeType = 0 #0 for 16M Airbrakes (Harder), 1 for 26L Airbrakes (Broken don't use).
    
    #26L Airbrakes are more modern, and can provide up to 90psi of pressure. The Increase and Decrease keys will add/subtract pressure for as long as you hold them.
    #16M Airbrakes are older. There are three Notches: "Release," "Lap," and "Apply." While in "Release" or "Apply," the
    #brake pressure will continually increase or decrease until it hits the upper or lower limit. In "Lap," the pressure will be held constant.
    
    Gearing = "74:18" #Traction motor Gear Ratio. 62:15 is the standard freight gearing. Larger 1st numbers trade tractive effort for speed.
    
    HEP = 0 #Set this to 1 if the locomotive is equipped for passenger service and uses the Prime Mover as HEP generators.
    DPM = 0 #if 1, will play an additional prime mover sound in addition to the main one
    BrakeMul = 755 #Don't Touch This
    
    #--------------
    #Control Config
    #--------------
    
    #You can actually change this, but be careful.
    #Wiremod key names do not always coincide with source key names!
    
    Alternate = "lshift" #When pressing this key, all controls with "!ALT" next to them will be triggered, and all the other will be ignored.
    
    Controls["ReverserF",string]        = "W"
    Controls["ReverserB",string]        = "S"
    
    Controls["IncreaseThrottle",string] = "D"
    Controls["DecreaseThrottle",string] = "A"	
    
    Controls["IncreaseDynamics",string] = "D !ALT"
    Controls["DecreaseDynamics",string] = "A !ALT"
    
    Controls["IncreaseTrainBrake",string]    = "W !ALT"
    Controls["DecreaseTrainBrake",string]    = "S !ALT"
    
    Controls["IncreaseLocoBrake",string] = "rcontrol"
    Controls["DecreaseLocoBrake",string] = "ralt"
    
    
    Controls["EmergencyBrake",string] = "rshift"
    
    Controls["HandBrake",string] = "H"
    Controls["Sander",string] = "period"
	 

    
    #Ignore this
    ControlPrintOrder = array("ReverserF","ReverserB","IncreaseThrottle","DecreaseThrottle","IncreaseDynamics","DecreaseDynamics","IncreaseTrainBrake","DecreaseTrainBrake","IncreaseLocoBrake","DecreaseLocoBrake","EmergencyBrake","HandBrake","Sander","FrontLights","RearLights","LogoLights","Beacon","Horn","Bell")
    
    
    #-------------------------
    #custom RLC SH configs
    #-------------------------
  
       
    StartupClagStart = 0.01    #Clag Config
    StartupClagDuration =6
    Fueladdclag=3000 #when older engines add fuel during turn over from the governer bar if newer keep it at 0
    Fueladdclaglength=500
    Clagrunonstarttime=10
    Stroke=4 # how many cycles does the engine run with. only used for the exhaust inputs are only 2 and 4 please don't use others. it fucks shit up 
    Notch4Warming=0
    StartupTime=9000
    ShutdownTime=0
    IDLEup = 0
    IDLEdown = 0
    IdleDown = "soldotensoundportspublic/engines/emd645e3v20early/transitions/down/1-0.wav"
    IdleUp = "soldotensoundportspublic/engines/emd645e3v20early/transitions/up/0-1.wav"
    LowIdle = "soldotensoundportspublic/engines/emd645e3v20early/idle_low.wav" #Don't touch these unless you know what you are doing!
    Idleuptime=4500
    Idledowntime=4500
    FuelSaver = 0
    FuelSaverNew=0
    LowIdling = 0
    LowidleTimer=5000 
    SplitShutDowns = 0
    Customlabeling=1
    CutomRRname="LRI"  #only works if Customlabeling is set to 1
    Letters="A"        #only works if Customlabeling is set to 1
    Minnumber=1       #only works if Customlabeling is set to 1
    Maxnumber=99      #only works if Customlabeling is set to 1
    #You probably shouldn't touch anything below here unless you REALLY know what you're doing.
    
    #\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
    
    #-----------------
    #Sound Config
    #-----------------

   StartupTime=12000
    ShutdownTime=0
    Startup = "gsgtrainsounds/alco244dv12/startup.wav"   #Startup and Shutdown
    Shutdown1 = "gsgtrainsounds/alco244dv12/shutdown.wav"
    Shutdown2 = "gsgtrainsounds/alco244dv12/shutdown.wav"  #Startup and Shutdown

    
    StartupClagStart = 0.01    #Clag Config
    StartupClagDuration =3
        
Idles = array(                                  #Sounds used for each Notch
    "gsgtrainsounds/alco244dv12/idle.wav",
    "gsgtrainsounds/alco244dv12/notch1.wav",
    "gsgtrainsounds/alco244dv12/notch2.wav",
    "gsgtrainsounds/alco244dv12/notch3.wav",
    "gsgtrainsounds/alco244dv12/notch4.wav",
    "gsgtrainsounds/alco244dv12/notch5.wav",
    "gsgtrainsounds/alco244dv12/notch6.wav",
    "gsgtrainsounds/alco244dv12/notch7.wav",
    "gsgtrainsounds/alco244dv12/notch8.wav"
)

Transition = "gsgtrainsounds/alco244dv12/transitions/"
                    #1-2  2-3  3-4  4-5  5-6 6-7 7-8 
    UpDelays = array(1800,2700,2100,2250,2400,2150,2250)
                      #8-7  7-6  6-5 5-4 4-3 3-2 2-1
    DownDelays = array(1600,1300,990,2600,2350,2570,5250)
                    #0-1 1-2 2-3 3-4 4-5 5-6 6-7 7-8
    Behavior = array(1,  0,  0,  0,  0,  0,  0,  0)
    #0: Normal A/B Notching
    #1: Full Sweep
    #2: Instant Transition
    #3: No Change
    #///////////////////////////////////
  
    
    Lever_ReverserF = "gsgtrainsounds/misc/cab/reverser_fr_4.wav"      #Cab Lever Sounds
    Lever_ReverserN = "gsgtrainsounds/misc/cab/reverser_neutral_4.wav"
    Lever_ReverserB = "gsgtrainsounds/misc/cab/reverser_fr_4.wav"
    
    Lever_Throttle = "gsgtrainsounds/misc/switch_rotating.wav" 
    
    Lever_16M = "gsgtrainsounds/misc/cab/reverser_fr_3.wav"
    Lever_26L = "gsgtrainsounds/misc/desktop/button_toggle_off.wav"
    
    Lever_LocoBrake = "gsgtrainsounds/misc/air_switch.wav"
    Lever_HandBrake = "titus's_trainbuild_content_pack_1.1/propper/misc/handbrake02.wav"
    
    WheelSound = "_jazzlok/traction/wheel_joint_loop.wav"     #Wheel Noises
    BrakeScreech = "_jazzlok/brakes/braking03.wav"             #Brake Screech
    
    AirBrakeApply = "titus's_trainbuild_content_pack_1.1/brakes/auto/autobrake01.wav"     #Sounds for Trainline Airbrakes
    AirBrakeRelease = "titus's_trainbuild_content_pack_1.1/brakes/auto/autobrake01.wav"   
    
    LocoBrakeRelease = "titus's_trainbuild_content_pack_1.1/brakes/auto/autobrake13.wav" #Locomotive brakes' apply sounds are very quiet so we just included a release.
    EmergencyBrakeSound = "_jazzlok/brakes/brake_valve_flow_emergency.wav"  #The sound of the engineer shitting his pants
    
    CompressorRunning = "gsgtrainsounds/misc/compressors/wh_3cdc_loop.wav"

    CompressorStartGE="engines/gevo12/misc/compressor_start2.wav"
    CompressorStartEMD="gsgtrainsounds/misc/compressors/gardner-denver_wbo_f40ph/gd_wbo_f40ph_start.wav"
    CompressorStop="gsgtrainsounds/misc/compressors/wh_3cdc_end.wav"
    Compressortype=2
    ShaftDriven=1
    Compstarttime=7000
    
    SanderOn = "gsgtrainsounds/misc/cab/sand_loop3.wav"    #Not to be confused with Bernie Sanders
    SanderOff = "gsgtrainsounds/misc/cab/sand_end3.wav"
    
    WheelSlipSound1 = "gsgtrainsounds/wheels/wheelslip_loop.wav"  #Sounds for Wheelslip
    WheelSlipSound2 = "gsgtrainsounds/wheels/wheelslip_end.wav"
    
    Threshold_Hard = 0.25 #Speed, in mph, below which the train brakes will hold the train.
    
    
    DPM_Delay = 200 #Delay in ms for the 2nd prime mover to get the message
    DPM_Pitch = 2 #Extra Pitch to give the 2nd Prime Mover
if(Compressortype==2){soundPlay(800,0,CompressorRunning)}

     foreach(K,V:string = Controls){
        if(V:find(" !ALT")){
            Routing[K,number] = 1
            local EXP = V:explode(" ")
            Controls[K,string] = EXP[1,string]
        }else{
            Routing[K,number] = 0
        }
    }
    
    #Sounds Init
    
    #DPM
     if(DPM){
        DPMH = holoCreate(0,entity():isWeldedTo():pos(),vec(1),ang(),vec(255),"cube")
        holoParent(0,entity())
        DPMH:propDraw(0)
        
    }
    
    function void lowidlestop(){
        stoptimer("lowidlestart")
        #print("                Stopping Timer")
        SaverQ = 0
    }
    
    #Tickrate-Adjusted Sound Duration
    function number sdr(Soundpath:string){
        local Tick = round(1/tickInterval())
        
        return floor(soundDuration(Soundpath)*100)*10/((Tick==ServerSideTickRate2) ? 2 : 1)
    }
    
    function number startTransition(From,To){
        lowidlestop()
        
        if(To > From){
            Clag = 1
            
            local BType = Behavior[From+1,number]
             if(LowIdling){
                #LowIdling = 0
                LowIdling = 0
                local Snd = IdleUp
                W:soundPlay(0,0,IdleUp)
                if(DPM){
                    DPMS = IdleUp
                    timer("dpm",DPM_Delay)
                }
                
                timer("level",sdr(Snd))
                
                
                return From+1
            }
           
            elseif(BType==1){
              
                local Nc = From:toString()
                local Nn = (From+1):toString()
                local Snd = Transition + "up/" + Nc + "-" + Nn + ".wav"
                W:soundPlay(0,0,Snd)
                local SDR = sdr(Snd)
                timer("level",SDR)
                timer("manclag",floor(SDR/20)*10)
                Mode3Q = 0
                #print("============Full")
                return From 
                
                if(DPM){
                    DPMS = Snd
                    timer("dpm",DPM_Delay)
                }
            }elseif(BType==0){
                #Normal AB
                local Nc = From:toString()
                local Nn = (From+1):toString()
                local Snd = Transition + "up/" + Nc + "-" + Nn + "a.wav"
                W:soundPlay(0,0,Snd)
                timer("abu",sdr(Snd))
                return From
                
                if(DPM ){
                    DPMS = Snd
                    timer("dpm",DPM_Delay)
                }
            }elseif(BType>=2){
                timer("level",500)
                if(BType==3){
                    Mode3Q = 1
                }
                return From+1
       
        }
                
        
        }elseif(To < From){
            Clag = 0
            local BType = Behavior[From,number]
            #print("                                " + BType)
            #Pod:printDriver(BType:toString())
        if(BType==1){
                #Full Sweep
                local Nc = From:toString()
                local Nn = (From-1):toString()
                local Snd = Transition + "down/" + Nc + "-" + Nn + ".wav"
                W:soundPlay(0,0,Snd)
                timer("level",sdr(Snd))
                Mode3Q = 0
                #print("============Full")
                return From-1
                
                if(DPM){
                    DPMS = Snd
                    timer("dpm",DPM_Delay)
                }
            }elseif(BType==0){
                #Normal AB
                local Nc = From:toString()
                local Nn = (From-1):toString()
                local Snd = Transition + "down/" + Nc + "-" + Nn + "a.wav"
                W:soundPlay(0,0,Snd)
                timer("abd",sdr(Snd))
                return From
                
                if(DPM ){
                    DPMS = Snd
                    timer("dpm",DPM_Delay)
                } 
            }elseif(BType>=2){
                timer("level",500)
                
                if(BType==3){
                    Mode3Q = 1
                }
                return From-1
                
            }
        }else{
            return From
        }
        
    }
    function number tq_evaluate(From,To){
        return    (From!=To)
    }
    function void entity:printProper(Message:string){
        if(This==O){
            print(Message)
        }else{
            Pod:printDriver(Message)
        }
    }
    
    #Locomotive Init
    Notch = 0
    RealNotch = 0
    Reverser = 0
    AB16M_Notch = AirBrakeType ? 0 : 1
    LB16M_Notch = -1
    
    function number entity:extraProps(Init){
        local Extra = Switching ? 0 : floor((E:getConstraints():count() - Init)/3)
        MaxTrainBrakeForce = BrakeMul*Extra/(70)
        return Extra
        
    }
    function void array:abRest(){
        
        foreach(K,V:entity = This){
            V:propPhysicalMaterial("phx_tire_normal")
        }
    }
    function void entity:abRelease(){
        local Ents = E:getConstraints()
        foreach(K,V:entity = Ents){
            V:propPhysicalMaterial("friction_00")
        }
    }
   
    
    
    #Misc Init 
Loco = " running RLC SH Version: "+Version
    Starting = 0
    SQ = 0
    On = 0
    NQ = 0
    DNQ = 0
    TQ = 0
    Notch = 0
    RealNotch = 0
    DynaNotch = -1
    Clag = 0
    RevQ = 0
    DynaQ = 0
    BlendQ = 0
    RLCPT = E = entity()
    O = owner()
    ABQ = 0
    LBQ = 0
    WQ = 0
    BQ = 0
    Mode3Q = 0
    local GetGears = Gearing:explode(":")
    local GIn = GetGears[1,string]:toNumber()
    local GOut = GetGears[2,string]:toNumber()
    LB16M_Notch=0
    local GearRatio = GOut/GIn
    GR = GearRatio*62/15
    
    MainRes = 0
    EqualRes = 0
    BrakeLine = 0
    BrakeCyl = 0
    
    #MaxER = AirBrakeType ? 90 : 70
    #AB26L = AirBrakeType ? 45 : 0
    #LB26L = 0
    #TrainBrakePressure = MaxER/2
    LocoBrakePressure = 0
    #ER = 0
    
    BrakeInfo = array(MainRes,EqualRes,BrakeLine,LocoBrakePressure,BrakeCyl)
    LB26L_ClickQ = 0
    BPQ = 0
    EMQ = 0
    Locked = 0
    Emergency = 0
    THQ = IHQ = 0
    HBQ = 0
    Compressorallow=0
    WheelSlipProb = 1/32
    SandQ = 0
    Sanding = 0
    WSQ = 0
    WSC = 0
    
    Trig2 = 0
    OldNotch = 0
    #HEP_Notch = 0
    HEP_Mode = 0
    HEPQ = 0
    
    Switching = 0
    
    LowIdling = 0
    
    FrontPlugOut = array()
    RearPlugOut = array()
    
    W = E:isWeldedTo()
    
    E:setSubMaterial(2,"bobsters_trains/br_blue")
    
    CarCount_Init = E:getConstraints():count()
    
    MaxLocoBrakeForce = 300000/70
    MaxTrainBrakeForce = 300000
    

    runOnChat(1)
    
    setName("RLC Sapphire Beta - V."+Version+"\n"+EngineType+"\n"+LocomotiveType+"\n"+RR+" "+LNumber)
}
#=============================
#Startup & Shutdown, Misc Clks
#=============================

if(Start & !SQ){
    SQ = 1
    Starting = !Starting

    if(Starting){
        
       
        local Snd = Startup
        W:soundPlay(50,0,Startup)
        timer("startclag",1000*StartupClagStart)
        timer("run",StartupTime)

        
        stoptimer("statsounddelay")

        if(DPM){
            DPMS = Snd
            timer("dpm",sdr(Snd)-500)
        }
}

elseif(IDLEdown&!LowIdling){
        soundStop(0)
        On=0
        FrontPlugOut = array()
        RearPlugOut = array()
        local Snd = IdleDown
        soundStop(0)
        timer("count",Idledowntime/1.3)
        W:soundPlay(50,0,IdleDown)
        timer("Stop1",Idledowntime)
        if(DPM){
            DPMS = Snd
            timer("dpm",sdr(Snd))
        }
}else{
        On = 0
        FrontPlugOut = array()
        RearPlugOut = array()
        local Snd = Shutdown1
        W:soundPlay(50,0,Shutdown1)
        soundStop(0)
        timer("run",9000)
        stopAllTimers()
        timer("cool",10*floor(soundDuration(Snd)*50))
        if(DPM){
            DPMS = Snd
            timer("dpm",sdr(Snd))
        }
}
}elseif(!Start & SQ){
    SQ = 0
    
}

if(clk("Stop1")&!LowIdling&IDLEdown){
On=0
stoptimer("Stop1")
local Snd = Shutdown2
W:soundPlay(50,0,Shutdown2)}


if(Starting & clk("run")&!LowIdling&IDLEup){
timer("run2",Idleuptime/2)
        local Snd = IdleUp
W:soundPlay(50,0,IdleUp)}


if((Starting & clk("run2")&!LowIdling&IDLEup)|(Starting & clk("run")&!LowIdling&!IDLEup)){
    On = 1
    W:soundPlay(0,0,Idles[1,string])
    RealNotch = 0
    Notch = 0
    timer("count",Idleuptime)
    CarCount = E:extraProps(CarCount_Init)
    if(DPM){
        #print("Run")
        DPMS = LowIdling ? LowIdle : Idles[1,string]
        timer("dpm",sdr(Startup))
        
    }
}
if(Starting & clk("run")&LowIdling){
    On = 1
    W:soundPlay(0,0,LowIdle)
    RealNotch = 0
    Notch = 0
    timer("count",Idleuptime)
    CarCount = E:extraProps(CarCount_Init)
    if(DPM){
        #print("Run")
        DPMS = LowIdling ? LowIdle : Idles[1,string]
        timer("dpm",sdr(Startup))
        
    }
    #Compressing = 1
    #W:soundPlay(8,0,CompressorOn)
    #if(!MU_Master){TrainBrakePressure=0}
    
}
if(clk("cool")){
    soundStop(0)
    if(Compressing){
        W:soundPlay(8,2,CompressorStop)
        Compressing = 0
    }
    #ER = 0
        
}elseif(clk("startclag")){
    Clag = 1
    DynaClag = 1
    timer("endclag",StartupClagDuration*1000)
}elseif(clk("endclag")){
    Clag = 0
    DynaClag = 0
}elseif(clk("count")){
    CarCount = E:extraProps(CarCount_Init)
    
    if(MU_Master){
        MU_OffsetPitch = 0
    }else{
        local CF = (FrontPlugIn:count()>=5)
        local CR = (RearPlugIn:count()>=5)
        MU_OffsetPitch = (CF&CR) ? -2 : 2
    }
    if(!Compressing & (MainRes > 0)){MainRes += -1}
    timer("count",5000)
}elseif(clk("THQ")){
    THQ = 0
    soundStop(5)
}elseif(clk("IHQ")){
    IHQ = 0
    soundStop(5)
}elseif(clk("manclag")){
    RealNotch++
}elseif(clk("WheelSlipEnd")){
    WheelSlip = 0
    soundStop(7)
    WSQ = 1
    timer("WheelSlipStart",500)
}elseif(clk("WheelSlipStart")){
    WSQ = 0
}elseif(clk("mu_recheck")){

    if(DynamicsEnable){
        local MU_Dynamics = FrontPlugIn[4,number] + RearPlugIn[4,number]
        if(MU_Dynamics & !Dynamics){
            Dynamics = 1
        }elseif(!MU_Dynamics & Dynamics){
            Dynamics = 0 
        }
    }
    
    local NotchMU = 0.8*(FrontPlugIn[2,number] + RearPlugIn[2,number])
    
    if(!Dynamics & (Notch!=NotchMU)){
        Notch = NotchMU
        TQ = tq_evaluate(RealNotch,Notch)
        RealNotch = startTransition(RealNotch,Notch)
    }elseif(Dynamics & DynaNotch!=NotchMU){
        DynaNotch = NotchMU
        if(DynamicsEnable==1){
            Notch = StepDynaNotch
            if(!TQ){
                TQ = tq_evaluate(RealNotch,Notch)
                RealNotch = startTransition(RealNotch,Notch)
            } 
        }
    }
}elseif(clk("dpm")){
    DPMH:soundPlay(7,0,DPMS)
    #print(DPMS)
    soundPitch(7,100+DPM_Pitch)
}elseif(clk("highidle")){
    Pod:printDriver("[RLC Sapphire "+RR+" - "+LNumber+"]: Unit is now high idling")
    local Snd = Idles[1,string]
    W:soundPlay(0,0,Snd)
    if(DPM){
        DPMS = Snd
        timer("dpm",DPM_Delay)
    }
}elseif(clk("lowidlestart")){
    #print("lowidlestart")
    
    LowIdling = 1
    local Snd = IdleDown
    W:soundPlay(0,0,IdleDown)
    if(DPM){
        DPMS = Snd
        timer("dpm",DPM_Delay)
    }
    timer("lowidle",Idledowntime)
}elseif(clk("lowidle")){
    Pod:printDriver("[RLC Sapphire "+RR+" - "+LNumber+"]: Unit is now low idling")
    W:soundPlay(0,0,LowIdle)
    if(DPM ){
        DPMS = LowIdle
        timer("dpm",DPM_Delay)
    }
}
if(ServerSideTickRate==0){ServerSideTickRate2=30}
if(ServerSideTickRate==1){ServerSideTickRate2=33}
if(ServerSideTickRate==2){ServerSideTickRate2=66}
if(ServerSideTickRate==3){ServerSideTickRate2=128}
if(Hep_On){soundVolume(11,255)}else{soundVolume(11,0)}

#==============
#Engine Running
#==============


if(On|EqualRes>0|MainRes>0){
    if(Reverser==0){interval(200)
        W:setMass(2000)}
    if(Reverser==1|Reverser==-1){interval(100)
    W:setMass(1000)}

    if(Trig2){
        Trig2 = 0
        Trig = 1
    }else{
        Trig = 0
    }
    if(LoadTest&RealTemp>150){Loadtestrunning=1}
    if(!LoadTest&Loadtestrunning&RealNotch==0){Loadtestrunning=0 Reverser=0}
   


    if(On&Notch4Warming&RealTemp<60&Reverser==0&Time>2&Notch<4){IncreaseThrottle2=1}
    if(On&Notch4Warming&RealTemp<60&Reverser==0&Time<2){IncreaseThrottle2=0}
    if(On&Notch4Warming&RealTemp>100&Reverser==0&Time>2&Notch>0){DecreaseThrottle2=1}
    if(On&Notch4Warming&RealTemp>100&Reverser==0&Time<2){DecreaseThrottle2=0}
    
    if(ETC==1&WheelSlip&Time>2){DecreaseThrottle3=1}
    if(ETC==1&Time<2){DecreaseThrottle3=0}
    #------------------
    #Control Resolution
    #------------------
    
    Driver = Pod:driver()
      
    
        local Shifting = Driver:keyPressed(Alternate)
        local RF = UsingRearSeat ? "ReverserB" : "ReverserF"
        local RB = UsingRearSeat ? "ReverserF" : "ReverserB"

if(Notch4Warming&RealTemp<150){
IncreaseThrottle = IncreaseThrottle2
DecreaseThrottle = DecreaseThrottle2

        }elseif(MU_Master&Driver){
        IncreaseThrottle = Driver:keyPressed(Controls["IncreaseThrottle",string]) & (Routing["IncreaseThrottle",number] ? Shifting : !Shifting)
        DecreaseThrottle = DecreaseThrottle3+Driver:keyPressed(Controls["DecreaseThrottle",string]) & (Routing["DecreaseThrottle",number] ? Shifting : !Shifting)
        }
         if(MU_Master&Driver){ 
        ReverserF = Driver:keyPressed(Controls[RF,string]) & (Routing[RF,number] ? Shifting : !Shifting)
        ReverserB = Driver:keyPressed(Controls[RB,string]) & (Routing[RB,number] ? Shifting : !Shifting)
        
       
        IncreaseTrainBrake = Driver:keyPressed(Controls["IncreaseTrainBrake",string]) & (Routing["IncreaseTrainBrake",number] ? Shifting : !Shifting)
        DecreaseTrainBrake = Driver:keyPressed(Controls["DecreaseTrainBrake",string]) & (Routing["DecreaseTrainBrake",number] ? Shifting : !Shifting)
        
        IncreaseLocoBrake = Driver:keyPressed(Controls["IncreaseLocoBrake",string]) & (Routing["IncreaseLocoBrake",number] ? Shifting : !Shifting)
        DecreaseLocoBrake = Driver:keyPressed(Controls["DecreaseLocoBrake",string]) & (Routing["DecreaseLocoBrake",number] ? Shifting : !Shifting)
        
        if(DynamicsEnable){
            IncreaseDynamics = Driver:keyPressed(Controls["IncreaseDynamics",string]) & (Routing["IncreaseDynamics",number] ? Shifting : !Shifting)
            DecreaseDynamics = Driver:keyPressed(Controls["DecreaseDynamics",string]) & (Routing["DecreaseDynamics",number] ? Shifting : !Shifting)
        }
        EmergencyBrake = Driver:keyPressed(Controls["EmergencyBrake",string]) & (Routing["EmergencyBrake",number] ? Shifting : !Shifting)
        
        HandBrake = Driver:keyPressed(Controls["HandBrake",string]) & (Routing["HandBrake",number] ? Shifting : !Shifting)
        Sander = (ASOFF)+(ASON)+Driver:keyPressed(Controls["Sander",string]) & (Routing["Sander",number] ? Shifting : !Shifting)
		


    }elseif(!MU_Master){
        #------------
        #MU Receiving
        #------------
        
        if(FrontPlugIn[5,number] | RearPlugIn[5,number]){
            stoptimer("mu_recheck")
            timer("mu_recheck",100)
            
            Reverser = -FrontPlugIn[1,number] + RearPlugIn[1,number]
            
            
            
            print("[RLC Sapphire "+RR+"-"+LNumber+"]: Received Input From Lead Unit")
            
            
            
            if(DynamicsEnable){
                local MU_Dynamics = FrontPlugIn[4,number] + RearPlugIn[4,number]
                if(MU_Dynamics & !Dynamics){
                    Dynamics = 1
                }elseif(!MU_Dynamics & Dynamics){
                    Dynamics = 0 
                }
            }
            
            local ThrottleMU = FrontPlugIn[2,number] + RearPlugIn[2,number]
            Notch = Dynamics ? Notch : ThrottleMU*0.8
            DynaNotch = Dynamics ? ThrottleMU*0.8 : -1
            
            if(!Dynamics){
                TQ = tq_evaluate(RealNotch,Notch)
                RealNotch = startTransition(RealNotch,Notch)
            }
            
            Sanding = FrontPlugIn[6,number] + RearPlugIn[6,number]
            
        }
    }
            
    #-----------------
    #Engine Sound Code
    #-----------------

    
    if(IncreaseThrottle & !NQ & (Notch<8) & !Dynamics){
        NQ = 1
        Notch++
        if(!TQ){
            #TQ = RealNotch==0 ? 0 : 1
            
            
            TQ = tq_evaluate(RealNotch,Notch)
            RealNotch = startTransition(RealNotch,Notch)
            
            
            Pod:soundPlay(1,0.5,Lever_Throttle)
        }
        Trig = 1
    }
    
    if(clk("abu")){
        #print("ab up")
        local Nc = RealNotch:toString()
        local Nn = (RealNotch+1):toString()
        local Snd = Transition + "up/" + Nc + "-" + Nn + "b.wav"
        RealNotch++
        W:soundPlay(0,0,Snd)
        if((RealNotch < Notch) & (Behavior[RealNotch,number]==0)){
            timer("abu",UpDelays[RealNotch-1,number])
            #print(UpDelays[RealNotch-1,number])
        }else{
            timer("level",sdr(Snd))
            Mode3Q = 0
        }
        
        if(DPM ){
            DPMS = Snd
            timer("dpm",DPM_Delay)
        }
    }
    
    #Notch Down By Control
    
    if(DecreaseThrottle & !NQ & (Notch>0) & !Dynamics){
        NQ = 1
        Notch--
        if(!TQ){
            #TQ = RealNotch==1 ? 0 : 1
            
            TQ = tq_evaluate(RealNotch,Notch)
            RealNotch = startTransition(RealNotch,Notch)
            
            Pod:soundPlay(1,0.5,Lever_Throttle)
        }
        Trig = 1
    }
    if(!IncreaseThrottle & !DecreaseThrottle & NQ){
        NQ = 0
    }
    
    if(clk("abd")){
        #print("ab down")
        local Nc = RealNotch:toString()
        local Nn = (RealNotch-1):toString()
        local Snd = Transition + "down/" + Nc + "-" + Nn + "b.wav"
        #print(Snd)
        RealNotch--
        W:soundPlay(0,0,Snd)
        if((RealNotch > Notch) & (Behavior[RealNotch,number]==0)){
            timer("abd",DownDelays[8-RealNotch,number])
            #print(DownDelays[8-RealNotch,number])
        }else{
            timer("level",sdr(Snd))
            Mode3Q = 0
            #print("descending to " + (RealNotch-1))
        }
        
        if(DPM ){
            DPMS = Snd
            timer("dpm",DPM_Delay)
        }
    }
    
    #Leveling Out
    if(clk("level")){
        #print("----------------------Leveling at N" + RealNotch + ", Mode3Q = " + Mode3Q)
        if(RealNotch == Notch){
            Clag = 0
            if( !Mode3Q){
                W:soundPlay(0,0,Idles[RealNotch+1,string])
                
            }
            
            Mode3Q = 0
            soundPitch(0,100+MU_OffsetPitch)
            TQ = 0
            #print("levelout")
            if(DPM){
                DPMS = Idles[RealNotch+1,string]
                timer("dpm",DPM_Delay)
            }
            if(HEPQ){
                HEPQ = 0
                HEP_Lock = (HEP_Mode>0)
                Notch = RealNotch = 0
            }
        }else{
            TQ = 1
            RealNotch = startTransition(RealNotch,Notch)
            
            #print("This is what is happening!")
            local BType = Behavior[RealNotch+1,number]
            #print("                            "+BType)
            if(BType>=2){
                W:soundPlay(0,0,Idles[RealNotch+1,string])
            }
            
        }
    }
    
    #Count Clagula V3
    #Clag = Notch > RealNotch
    
    #----------------------------------
    #Shit you have to be in Notch 0 for
    #----------------------------------
    if(RealNotch==0){
        
        #Reverser
        
        if(ReverserF & !RevQ & (Reverser<1) & (!Dynamics)){
            RevQ = 1
            Reverser++
            Pod:soundPlay(1,1,Reverser==1 ? Lever_ReverserF : Lever_ReverserN)
            Trig = 1
        }elseif(ReverserB & !RevQ & (Reverser>-1) & (!Dynamics)){
            RevQ = 1
            Reverser--
            Pod:soundPlay(1,1,Reverser==-1 ? Lever_ReverserB : Lever_ReverserN)
            Trig = 1
        }elseif(!ReverserF & !ReverserB & RevQ){
            RevQ = 0
        }
        
        #Fuel Saver
if(FuelSaver){
            if((Reverser!=0) & LowIdling){
                LowIdling = 0
                local Snd = IdleUp
                W:soundPlay(0,0,IdleUp)
                if(DPM & !HEP_Lock){
                    DPMS = Snd
                    timer("dpm",DPM_Delay)
                }
                timer("highidle",sdr(Snd))
                lowidlestop()
                
            }elseif((Reverser!=0) & !LowIdling & SaverQ){
                lowidlestop()
            
            
            }elseif((Reverser==0) & !LowIdling & !SaverQ){
                
                lowidlestop()
                SaverQ = 1
               timer("lowidlestart",LowidleTimer)
              
            

                #print("                  Starting Timer")
            }
        }
        
    }
    #--------------
    #Dynamic Brakes
    #--------------
    if(DynamicsEnable){
        if(IncreaseDynamics & !DNQ & (DynaNotch<8)){
            #print("blah")
            DNQ = 1
            
            local CanEngage = (DynaNotch==-1) ? (RealNotch==0) : 1
            if((Reverser!=0) & CanEngage){
                DynaNotch++
                Pod:soundPlay(1,1,Lever_Throttle)
                Trig = 1
                if(DynamicsEnable==1){
                    Notch=StepDynaNotch
                  
                    if(!TQ){
                     TQ = tq_evaluate(RealNotch,Notch)
                RealNotch = startTransition(RealNotch,Notch)}
            
            
         }
                        if(DynamicsEnable==2){
                    Notch=2
                TQ = tq_evaluate(RealNotch,Notch)
                RealNotch = startTransition(RealNotch,Notch)
                    if(!TQ){
                        TQ = tq_evaluate(RealNotch,Notch)
                RealNotch = startTransition(RealNotch,Notch)}
            
         }
            }
            Dynamics = DynaNotch > -1
            
        }elseif(DecreaseDynamics & !DNQ & (DynaNotch>-1)){
            DNQ = 1
            
            if(Reverser!=0){
                DynaNotch--
                Pod:soundPlay(1,1,Lever_Throttle)
                Trig = 1
                if(DynamicsEnable==1){
                    Notch = StepDynaNotch
                    if(!TQ){
                        TQ = tq_evaluate(RealNotch,Notch)
                        RealNotch = startTransition(RealNotch,Notch)
                    }
                }
            }
            Dynamics = DynaNotch > -1
        }elseif(!IncreaseDynamics & !DecreaseDynamics & DNQ){
            DNQ = 0
        }
        #Dynamics = DynaNotch > 0
        
        if(Dynamics & !DynaQ){
            DynaQ = 1
            W:soundPlay(2,0,DynoOn)
            if(DynamicsEnable==3){
                Notch = 4
                TQ = tq_evaluate(RealNotch,Notch)
                RealNotch = startTransition(RealNotch,Notch)
            }
        }elseif(!Dynamics & DynaQ){
            DynaQ = 0
            W:soundPlay(2,7,DynoOff)
            if(DynamicsEnable==2){
                Notch = 0
                TQ = tq_evaluate(RealNotch,Notch)
                RealNotch = startTransition(RealNotch,Notch)
            }
             if(DynamicsEnable==3){
                Notch = 0
                TQ = tq_evaluate(RealNotch,Notch)
                RealNotch = startTransition(RealNotch,Notch)
            }
        }
        
    }
    #Blended Braking
    if(DynamicsEnable==4){
        
        local Blend = ((90-BrakeLine)>=10) & (MPH>5)
        #print(MU_Dynamics)
        if(Blend & !BlendQ & (Reverser!=0)){
            BlendQ = 1
            Dynamics = 1
            HEP_Lock = 1
            DynaNotch = 0
            #Pod:soundPlay(1,1,Lever_Throttle)
            #W:soundPlay(2,0,DynoOn)
            #print("Blend on")
            
        }elseif((!Blend | (Reverser==0)) & BlendQ){
            BlendQ = 0
            Dynamics = 0
            DynaNotch = -1
            HEP_Lock = (HEP_Mode>0)
            #W:soundPlay(2,7,DynoOff) 
            #print("Blend Off")
        }
        
    }
    
     #-----------------------
    #Velocity Info Gathering
    #-----------------------
      if(PT2speedreadings==1){
    V = -E:velL():z()
    MPH = toUnit("mph",abs(V))*4/3
    KPH = toUnit("km/h",abs(V))*4/3
Feet = 10*toUnit("mph",abs(V))*4/3
}else{  
    V = -E:velL():z()
    MPH = abs(toUnit("mph",V))
    KPH = abs(toUnit("km/h",V))
    Feet = 10*toUnit("mph",abs(V))
}
    Moving = MPH>Threshold_Hard
    #Wheel Sound
    if(Moving){
        if(!WQ){
            WQ = 1
            W:soundPlay(3,0,WheelSound)
        }
        soundPitch(3,MPH*3.3)
    }elseif(!Moving & WQ){
        WQ = 0
        soundStop(3)
    }
    
    
    #----------------------------
    #Instantaneous TE Calculation
    #----------------------------
    
  if(Reverser!=0 & !Dynamics & !HEPQ & (HEP_Mode != 1)){
        local Throttle = min(RealNotch,Notch)
        local TEG = TE_Starting*GR
        local HPG = Horsepower/GR
        TE = 2*Reverser*TEG*Throttle*exp(-100*MPH/HPG)
        #*2*Reverser*TEG*Throttle*exp(-100*MPH/HPG)
        
    }else{
        TE = 0
    }
    
    
    #--------------------------
    #Dynamic Brake Calculations
    #--------------------------
    
    if(Dynamics & DynamicsEnable&MPH>30){
        local Rightway = sign(V)==sign(Reverser)
        local Throttle = DynaNotch
        DynaForce = Reverser*(MPH*MPH)*Throttle*Horsepower*Rightway/16
    }elseif(Dynamics & DynamicsEnable&ExtendedDynamics&MPH>20){
        local Rightway = sign(V)==sign(Reverser)
        local Throttle = DynaNotch
    DynaForce = Reverser*(MPH*MPH)*Throttle*Horsepower*Rightway/16
    }else{
        DynaForce = 0
    }
    #==========================
    #Train Brake And Loco Brake
    #==========================
    
    local MU_Connected = (FrontPlugIn:count() + RearPlugIn:count()) > 5
    if(!MU_Master & MU_Connected){
        MainRes = FrontPlugIn[9,number] + RearPlugIn[9,number]
        #EqualRes = 90
        AB16M_Notch = -1
    }
    local NumCompressors = FrontPlugIn[8,number] + RearPlugIn[8,number] + 1
    
    
    
    #----------
    #Compresors
    #----------

    #--------------------
    #Equalizing Reservoir
    #--------------------
    
if(AirBrakeType){
        #26L Trainline
        if(IncreaseTrainBrake & (EqualRes>0) & !ABQ){
            ABQ = 1
            Pod:soundPlay(1,1,Lever_26L)
        }elseif(DecreaseTrainBrake & (EqualRes<90) & !ABQ){
            ABQ = 1
            Pod:soundPlay(1,1,Lever_26L)
        }elseif(!DecreaseTrainBrake & !IncreaseTrainBrake & ABQ){
            ABQ = 0
        }
        AB16M_Notch = IncreaseTrainBrake - DecreaseTrainBrake
    }else{
        #16M Trainline
        if(IncreaseTrainBrake & (AB16M_Notch<1) & !ABQ){
            ABQ = 1
            Pod:soundPlay(1,1,Lever_16M)
            AB16M_Notch++
        }elseif(DecreaseTrainBrake & (AB16M_Notch>-1) & !ABQ){
            ABQ = 1
            Pod:soundPlay(1,1,Lever_16M)
            AB16M_Notch--
        }elseif(!DecreaseTrainBrake & !IncreaseTrainBrake & ABQ){
            ABQ = 0
        }
        
    }
    #ER Hiss
    if((AB16M_Notch==1) & (EqualRes>0) & !THQ){
        THQ = 1
        Pod:soundPlay(5,4,AirBrakeApply)
        timer("THQ",6000)
    }elseif((AB16M_Notch==-1) & (EqualRes<90) & !THQ){
        THQ = 1
        Pod:soundPlay(5,4,AirBrakeRelease)
        timer("THQ",6000)
    }
    #ER Indexing
    if((AB16M_Notch==1) & (EqualRes>0)){
        EqualRes--
    }elseif((AB16M_Notch==-1) & (EqualRes<90)){
        EqualRes++
    }
    #----------
    #Brake Line
    #----------
    if(changed(CarCount) & (($CarCount)>0)){
        BrakeLine *= (CarCount - $CarCount)/CarCount
    }
    if(BrakeLine > EqualRes){
        #Apply
        BrakeLine -= 1/(CarCount/16 + 1)
        
        
    }elseif(BrakeLine < EqualRes){
        #Release
        if(MainRes >= 30){
            MainRes -= 0.125*(CarCount/4 + 1)/NumCompressors
            BrakeLine += 1/(CarCount/16 + 1)
        }
    }
    if(abs(EqualRes-BrakeLine)<=(1/(CarCount/16 + 1))){
        BrakeLine = EqualRes
    }
    
    #----------------
    #Locomotive Brake
    #----------------
    if(AirBrakeType){
        #26L Independent
        LB16M_Notch = IncreaseLocoBrake - DecreaseLocoBrake
        if(IncreaseLocoBrake & (LocoBrakePressure==90) & !LB26L_ClickQ){
            LB26L_ClickQ = 1
            Pod:soundPlay(1,1,Lever_LocoBrake)
        }elseif(LocoBrakePressure<90){
            LB26L_ClickQ = 0
        }
    }else{
        #16M Independent
        if(IncreaseLocoBrake & (LB16M_Notch<1) & !LBQ){
            LBQ = 1
            LB16M_Notch++
            if(LB16M_Notch==1){Pod:soundPlay(1,1,Lever_LocoBrake)}
        }elseif(DecreaseLocoBrake & (LB16M_Notch>-1) & !LBQ){
            LBQ = 1
            LB16M_Notch--
        }elseif(!DecreaseLocoBrake & !IncreaseLocoBrake & LBQ){
            LBQ = 0
        }
    }
    #LB Hiss
    if((LB16M_Notch==-1) & (LocoBrakePressure>0) & !IHQ){
        IHQ = 1
        Pod:soundPlay(5,4,LocoBrakeRelease)
        timer("IHQ",6000)
    }
    
    #LB Indexing
    if((LB16M_Notch==1) & (LocoBrakePressure<90)){
        LocoBrakePressure++
    }elseif((LB16M_Notch==-1) & (LocoBrakePressure>0)){
        LocoBrakePressure--
        
        if(LocoBrakePressure>(90-BrakeLine)){MainRes -= 0.125/NumCompressors}
    }
      if(LB16M_Notch==0&AB16M_Notch==1&LocoBrakePressure<90){LocoBrakePressure++}
      if(LB16M_Notch==-1&AB16M_Notch==0&LocoBrakePressure<1){LB16M_Notch=0}
    
    #Cylinder
    BrakeCyl = max(LocoBrakePressure,90-BrakeLine)/2.5
    
    #Brake Info Array
    BrakeInfo = array(MainRes,EqualRes,BrakeLine,LocoBrakePressure,BrakeCyl)
    

  

    #Emergency Brake
    if((EmergencyBrake | EmBrake) & !Emergency){
        Emergency = 1
        BrakeLine = 0
        EqualRes = 0
        AB16M_Notch = 2
        
        local Ents = E:getConstraints()
        foreach(K,V:entity=Ents){
            V:propPhysicalMaterial("slipperyslime")
        }
        
        Pod:soundPlay(5,0,EmergencyBrakeSound)
        Pod:soundPlay(1,1,AirBrakeType ? Lever_26L : Lever_16M)
        
        
        Notch = 0
        TQ = tq_evaluate(RealNotch,Notch)
        RealNotch = startTransition(RealNotch,Notch)
        
        Trig = 1
    }
    
    Brake = (BrakeCyl > 0)
    
    #Brake Screeching Sounds
    local Screech = Moving & Brake & (MPH<40)
    if(Screech & !BQ){
            BQ = 1
        W:soundPlay(4,0,BrakeScreech)
    }elseif(!Screech & BQ){
        BQ = 0
        soundStop(4)
    }
    
    #Train Brake Physprops
    if(Brake & (MPH<Threshold_Hard) & !BPQ){
        BPQ = 1
        Trucks:abRest()
        Locked = 1
        
    }elseif(!Brake & BPQ){
        BPQ = 0
        E:abRelease()
        Locked = 0
        Emergency = 0
        CarCount = E:extraProps(CarCount_Init)
    }
    
    #Handbrake
    if(HandBrake & !HBQ){
        HBQ = 1
        Pod:printDriver("[RLC Sapphire "+RR+" - "+LNumber+"]: Hold key to Apply Handbrakes.")
        timer("HB_Check",1000)
    }elseif(!HandBrake & HBQ){
        HBQ = 0
    }
    
    #Train Brake Force Calculation
    if((MPH>Threshold_Hard)&!Locked){
        if(CarCount<1){
            CarCount = E:extraProps(CarCount_Init)
        }
        local TBF = CarCount*(90-BrakeLine)*MaxTrainBrakeForce
        local LBF = ((90-BrakeLine)>LocoBrakePressure ? (90-BrakeLine) : LocoBrakePressure)*MaxLocoBrakeForce
        BrakingForce = sign(V)*(LBF+TBF)
        
    }else{
        BrakingForce = 0
        #LocoBrakingForce = 0
    }
    
    #------------------
    #WheelSlip & Sander
    #------------------
    if(Sander & !SandQ){
        SandQ = 1
        Trig = 1
        Sanding = !Sanding
        W:soundPlay(6,Sanding ? 0 : 2, Sanding ? SanderOn : SanderOff)
    }elseif(!Sander & SandQ){
        SandQ = 0
    }
    
    if(ETC!=2 & (Reverser!=0) & !Brake & !Dynamicsruning & (Brakerin==-2|!Allow_TC_overload)){
        
        #Sander
#[        if(Sander & !SandQ){
            SandQ = 1
            W:soundPlay(6,0,SanderOn)
            Trig = 1
        }elseif(!Sander & SandQ){
            SandQ = 0
            W:soundPlay(6,2,SanderOff)
            Trig = 1
        }]#
        
         #Wheelslip
        local Throttle = min(RealNotch,Notch)
        if((Throttle>4) & (MPH<10) & !WSQ){
            local SpeedThreshold = (Throttle - 4 - 2*Sanding)*2.5
            
            WheelSlippable = MPH<SpeedThreshold
        }else{
            WheelSlippable = 0
        }
        if(WheelSlippable & !WheelSlip){
            if(random()<(Sanding ? WheelSlipProb/2 : WheelSlipProb)){
                WheelSlip = 1
                
                soundPlay(7,5.5,WheelSlipSound1)
                WSC = !WSC
              
                                timer("WheelSlipEnd",5000)
            }

            
        }elseif(clk("WheelSlipEnd2")&WheelSlip){
            WheelSlip = 0
            
            stoptimer("WheelSlipEnd")
            soundPlay(7,2,WheelSlipSound2)
            timer("WheelSlipStart",5000)
        }
        if(WheelSlip){
            local TEMUL = ETC ? 0.5 : 0.25
            TE *= TEMUL
        }
        
        
    }else{
        WheelSlip = 0
        
    }
    
    #=================
    #Force Application
    #=================
if(Loadtestrunning){Force = TE - BrakingForce*2 - DynaForce 
Reverser=1
Loadlevel = 0-(floor(50*(abs(TE) - abs(DynaForce))/(TE_Starting*16)))}
elseif(Brakerin==-2|!Allow_TC_overload){  Force = TE - BrakingForce*2 - DynaForce 
        W:applyForce(-E:up()*(Force2))
        Loadlevel = (floor(100*(abs(TE) - abs(DynaForce))/(TE_Starting*16)))
}
else{ Force = 0 
        
    Loadlevel = 0}
        
    
    
 
    #==============
    #MU Info Output
    #==============
    
    local HP_Forward = Horsepower + RearPlugIn[7,number]
    local HP_Backward = Horsepower + FrontPlugIn[7,number]
    local Comps_Forward = 1 + RearPlugIn[8,number]
    local Comps_Backward  = 1 + FrontPlugIn[8,number] 
    
    if(MU_Master){
        local ThrottleMU = (Dynamics ? DynaNotch : Notch)*1.25
        RearPlugOut = array(-Reverser,ThrottleMU,0,Dynamics,Trig,Sanding,HP_Backward,Comps_Backward,MainRes)
        FrontPlugOut = array(Reverser,ThrottleMU,0,Dynamics,Trig,Sanding,HP_Forward,Comps_Forward,MainRes)
    }else{
        RearPlugOut = FrontPlugIn:clone()
        FrontPlugOut = RearPlugIn:clone()
        
        RearPlugOut[7,number] = HP_Backward
        FrontPlugOut[7,number] = HP_Forward
        
        RearPlugOut[8,number] = Comps_Backward
        FrontPlugOut[8,number] = Comps_Forward
        
    }
    
}
       OPS=ops()
    if(5<0+ClagLevel2+ClagLevel1+ClagLevel3+ClagLevel5+ClagLevel6+Clag){ClagLevel4=6}else{
    ClagLevel4=0+ClagLevel2+ClagLevel1+ClagLevel3+ClagLevel6+ClagLevel5+Clag-1}

    ClagString="clag_"+Stroke+"stroke_"+ClagLevel4
    if(Notch==RealNotch){ClagLevel1=0}
    if(Notch>RealNotch){ClagLevel1=1}
    if(Notch-RealNotch>1& Clag){ClagLevel1=2}
    if(Notch-RealNotch>2& Clag){ClagLevel1=3}
    if(Notch-RealNotch>3& Clag){ClagLevel1=4}
    if(Notch-RealNotch>4& Clag){ClagLevel1=5}
    if(AP&!Clagalowed){timer("Claggyalowed",Clagrunonstarttime)}
    if(clk("Claggyalowed")&!Clagalowed){Clagalowed=1 stoptimer("Claggyalowed")}
    if(!AP){Clagalowed=0}
    if(AP&Clagalowed&Clagtimer){ClagOn=1}else{ClagOn=0}
    if(AP&Clagalowed){Clagtimer++}
    if(Clagtimer>30){Clagtimer=0}
    if(Load < 5){ClagLevel2=0}
    if(Load < 10 & Load>5){ClagLevel2=1}
    if(Load < 20 & Load>10){ClagLevel2=2}
    if(Load < 50 & Load>20){ClagLevel2=3}
    if(Load < 90 & Load>50){ClagLevel2=4}
    if(Load < 95 & Load > 90){ClagLevel2=5}
    if(Load > 95){ClagLevel2=6}
    if(Load < -30){DynaClag=1} else{DynaClag = 0 }
    if(DynamicsEnable==1){   
    if(Dynamics&Load>-10&DynaNotch>0){StepDynaNotch=2}
    if(Dynamics&Load<-10&Load>-20&DynaNotch>0){StepDynaNotch=4}
    if(Dynamics&Load<-20&Load>-40&DynaNotch>0){StepDynaNotch=6}
    if(Dynamics&Load<-40&DynaNotch>0){StepDynaNotch=8}
    if(Dynamics&DynaNotch<1){StepDynaNotch=0}
    }
    if(ShaftDriven==1){soundPitch(8,80+CompRealnotch4+CompRealnotch)
    soundPitch(800,80+CompRealnotch4+CompRealnotch)
    if(RealNotch*5<CompRealnotch){CompRealnotch--}
    if(RealNotch*5>CompRealnotch){CompRealnotch++}
    if(LowIdling&CompRealnotch4>0){CompRealnotch4--}
    if(!LowIdling&CompRealnotch4<20){CompRealnotch4++}
}
    if(ShaftDriven==2){soundPitch(8,80+CompRealnotch)
                soundPitch(800,80+CompRealnotch)
    if(RealNotch>1|Reverser==0){REsp=1}else{REsp=0}
    if(On&REsp&50>CompRealnotch){CompRealnotch++}
    if(On&!REsp&0<CompRealnotch){CompRealnotch--}
}
        if(DynamicsEnable==1&Dynamics){
                    Notch = StepDynaNotch
                    if(!TQ){
                        TQ = tq_evaluate(RealNotch,Notch)
                        RealNotch = startTransition(RealNotch,Notch)
                    }
                }
if(Loadtestrunning|Dynamics){Dynamicsruning=1}else{Dynamicsruning=0}

if(Starting&!On&Fueladdclag>0){timer("clagruntime",Fueladdclag)}
if(clk("clagruntime")){
ClagLevel5=1
timer("clagruntime2",Fueladdclaglength)}
if(clk("clagruntime2")){ClagLevel5=0 stoptimer("clagruntime")}

    if(CarCount>36){CarCount2=128}else{CarCount2=CarCount+24}
    if(Compressing&!ShaftDriven){soundPitch(8,100)}
    if(Starting|On){AP=1}else{AP=0}
    RLCSHTrucks = array(Load,MPH,Dynamicsruning,WheelSlip,BrakeCyl,Reverser)
    RLCSHCom1 = array(MU_Master,Reverser,Notch,Dynamicsruning,DynaNotch,LocoBrakeRelease,LB16M_Notch,AB16M_Notch,MPH,Load,RealTemp,WheelSlip,Sanding,RealNotch)
    if(AllowTempSystem){ 
    if(On&RealNotch>0){RealTemp+=0.2*RealNotch}
    if(On){RealTemp-=RLCSHCoolingarrayin[1,number]}
    if(RealTemp<80){ClagLevel3=2}
    if(RealTemp<120&RealTemp>79){ClagLevel3=1}
    if(RealTemp<150&RealTemp>119){ClagLevel3=0}
    if(RealTemp>149){ClagLevel3=0}
    if(On&RealTemp>149){RealTemp+=0.1}
    if(On&RealTemp<150){RealTemp+=0.2}}else{RealTemp=155 ClagLevel3=0}
    if(Load<20&RealNotch>1){IdlePitch3=0}
    if(Load>20&Load<40&RealNotch>1){IdlePitch3=0.5}
    if(Load>40&Load<60&RealNotch>1){IdlePitch3=1}
    if(Load>60&Load<80&RealNotch>1){IdlePitch3=1.5}
    if(Load>80&Load<90&RealNotch>1){IdlePitch3=2}
    if(Load>90&Load<100&RealNotch>1){IdlePitch3=2.5}
    if(Load>100&RealNotch>1){IdlePitch3=3}
    if(RealNotch>0&RealNotch<3&Reverser!=0){IdlePitch3=3}
    if(RealNotch==0){IdlePitch3=0}
    if(RealNotch>RealNotch2&Notch==RealNotch){RealNotch2+=0.5}
    if(RealNotch<RealNotch2&Notch==RealNotch){RealNotch2=RealNotch}
    RLCSHCoolingarrayout=array(On,RealTemp)
    if(IdlePitch3>IdlePitch5){IdlePitch5++}
    if(IdlePitch3<IdlePitch5){IdlePitch5--}
    if(AP){soundVolume(0,2)}else{soundVolume(0,0) soundVolume(8,0) soundStop(0)}
    if(AP&Compressing){soundVolume(8,1.5)}
    if(CarCount>0){Force2=Force*2}else{Force2=Force/2}
    soundPitch(0,100-IdlePitch)
    soundPitch(50,100-IdlePitch)
    if(IdlePitch<10&RealNotch>0&RealNotch<8){Resp2=1}else{Resp2=0}
    if(Starting&Clag&!On){Startupdraw=1}else{Startupdraw=0 ClagLevel6=0 ClagLevel5=0}
    if(Starting){ClagLevel6=1}else{ClagLevel6=0}
    if(Resp2&Load/10>IdlePitch){IdlePitch++}
    if(Resp2&Load/10<IdlePitch){IdlePitch--}
    if(0<IdlePitch&!Resp2){IdlePitch--}
    if(RealTemp<150){Warming=1}else{Warming=0}
    if(Warming){Time++}
    if(Time>3){Time=0}
if(Loadlevel>Load){Load++}
if(Loadlevel<Load){Load--}
soundPitch(4,40+MPH*3)
soundVolume(4,BrakeCyl/10)
if(On){soundStop(50)}
if(!AP&!Compressing){soundVolume(800,0)}elseif(AP&!Compressing){soundVolume(800,0.2)}

if((!ASOFF&Sanding)&(MPH>12|Notch<5)&(ASrunning)){ASOFF=1  timer("ASoff",1000)}
if(clk("ASoff")){ASOFF=0 ASrunning=0 stoptimer("ASoff")}
if(WheelSlip&AS==1&!Sanding){ASON=1 ASrunning=1}else{ASON=0}



if(Brake&MPH<1){
        local Ents = E:getConstraints()
        foreach(K,V:entity = Ents){
        V:propPhysicalMaterial("rubber")
            }
        }else{  local Ents = E:getConstraints()
        foreach(K,V:entity = Ents){
        V:propPhysicalMaterial("super_ice")}
}




#Handbrake Check
if(clk("HB_Check")){
    if(HandBrake){
        local Ents = E:getConstraints()
        foreach(K,V:entity = Ents){
            V:propPhysicalMaterial("rubber")
            Handbrakeout=1
        }
        Pod:printDriver("[RLC Sapphire "+RR+" - "+LNumber+"]: Handbrakes Applied.")
        Pod:soundPlay(1,1,Lever_HandBrake)
    
    }
}


#Lever Unlock Indicator
Unlocked = On&(RealNotch==0)
if(Brake==0){Handbrakeout=0}
#=============
#Chat Commands
#=============

if(chatClk(O)|chatClk(Driver)){
    Speaker = lastSpoke()
    LS = lastSaid()
    
    local Sentence = LS:explode(" ")
    local CMD = Sentence[1,string]
    
    switch(CMD){
        case ".engine"+RR+LNumber,
            if(Speaker==O){
                SQ = 1
                
                   SQ = 1
    Starting = !Starting

    if(Starting){
        
       
        local Snd = Startup
        W:soundPlay(50,0,Startup)
        timer("startclag",1000*StartupClagStart)
        timer("run",StartupTime)

        
        stoptimer("statsounddelay")

        if(DPM){
            DPMS = Snd
            timer("dpm",sdr(Snd)-500)
        }
}

elseif(IDLEdown&!LowIdling){
        soundStop(0)
        On=0
        FrontPlugOut = array()
        RearPlugOut = array()
        local Snd = IdleDown
        soundStop(0)
        timer("count",Idledowntime/1.3)
        W:soundPlay(50,0,IdleDown)
        timer("Stop1",Idledowntime)
        if(DPM){
            DPMS = Snd
            timer("dpm",sdr(Snd))
        }
}else{
        On = 0
        FrontPlugOut = array()
        RearPlugOut = array()
        local Snd = Shutdown1
        W:soundPlay(50,0,Shutdown1)
        soundStop(0)
        timer("run",9000)
        stopAllTimers()
        timer("cool",10*floor(soundDuration(Snd)*50))
        if(DPM){
            DPMS = Snd
            timer("dpm",sdr(Snd))
        }
}
}elseif(!Start & SQ){
    SQ = 0
    
}

            hideChat(1)
            break
        case ".notch"+RR+LNumber,
            if(MU_Master & On){
                Notch = clamp(Sentence[2,string]:toNumber(),0,8)
                TQ = tq_evaluate(RealNotch,Notch)
                RealNotch = startTransition(RealNotch,Notch)
                TQ = tq_evaluate(RealNotch,Notch)
                RealNotch = startTransition(RealNotch,Notch)
                Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Setting Notch to " + Notch:toString() + ".")
                Trig2 = 1
            }elseif(On & !MU_Master){
                stoptimer("mu_recheck")
                timer("mu_recheck",1000)
            }
            hideChat(1)
            break
        case ".brake"+RR+LNumber,
            if(On){
                if(Sentence[2,string]==""){
                    Emergency = 1
                    EqualRes = BrakeLine = 0
                    
                    local Ents = E:getConstraints()
                    foreach(K,V:entity=Ents){
                        V:propPhysicalMaterial("slipperyslime")
                    }
                    AB16M_Notch = 2
                    Pod:soundPlay(5,0,EmergencyBrakeSound)
                    Pod:soundPlay(1,1,AirBrakeType ? Lever_26L : Lever_16M)
                    
                    
                    Notch = 0
                    TQ = tq_evaluate(RealNotch,Notch)
                    RealNotch = startTransition(RealNotch,Notch)
                    Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Oh fuck Applying Emergency Brake.")
                    Trig2 = 1
                }else{
                    local ToPressure = clamp(Sentence[2,string]:toNumber(),0,90)
                    if(!AirBrakeType){AB16M_Notch = 0}
                    EqualRes = 90-ToPressure
                    Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Setting " + ToPressure:toString() + " lb Application ("+EqualRes:toString()+" ER psi).")
                }
                hideChat(1)
                #Trig2 = 1
            }
            break
        case ".reverser"+RR+LNumber,
            if(MU_Master & On){
                Reverser = clamp(Sentence[2,string]:toNumber(),-1,1)
                Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Setting Reverser to " + Reverser:toString() + ".")
                Trig2 = 1
            }
            hideChat(1)
            break
        case ".dynamics"+RR+LNumber,
            if(On & MU_Master){
                if(DynamicsEnable){
                    local CanEngage = (DynaNotch==0) ? (RealNotch==0) : 1
                    if((Reverser!=0) & CanEngage){
                        
                        DynaNotch = Sentence[2,string]:toNumber()
                        Dynamics = DynaNotch > 0
                        Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Setting Dynamic Brakes to Notch " + Sentence[2,string] + ".")
                    }else{
                        Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]:Dynamic Brake Condition Invalid.. set the reverser first dumb ass")
                    }
                }else{
                    Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Oh it would seem Your Locomotive has no Dynamic Brakes. Your fucked XD")
                }
            }elseif(On & !MU_Master){
                stoptimer("mu_recheck")
                timer("mu_recheck",1000)
            }
            hideChat(1)
            break
        case ".handbrake"+RR+LNumber,
            if(MU_Master){
                local Ents = E:getConstraints()
                foreach(K,V:entity = Ents){
                    V:propPhysicalMaterial("rubber")
                }
                Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Handbrakes Applied.")
                Pod:soundPlay(1,1,Lever_HandBrake)
            }
            hideChat(1)
            break
        case ".controls"+RR+LNumber,
            if(MU_Master){
                for(K=1,ControlPrintOrder:count()){
                    local ControlName = ControlPrintOrder[K,string]
                    local X = Controls[ControlName,string]
                    if(Routing[ControlName,number]){
                        Speaker:printProper(ControlName + ": Shift + " + X)
                    }else{
                        Speaker:printProper(ControlName + ": " + X)
                    }
                }
            }
            hideChat(1)
            break
        case ".superice"+RR+LNumber,
            if(MU_Master){
                E:abRelease()
                Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Consist has been Super Iced.")
            }
            hideChat(1)
            break
        case ".count"+RR+LNumber,
            if(MU_Master){Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Your Train has " + CarCount:toString() + " cars.")}
            hideChat(1)
            break
        case ".weight"+RR+LNumber,
            if(MU_Master){
                local TMass = 0
                local TProps = E:getConstraints()
                for(N=1,TProps:count()){
                    TMass += TProps[N,entity]:mass()
                }
                TMass -= 80000
                local SCE = round(TMass/25000,1)
                Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Total Car Mass: " + SCE:toString() + " SCE.")
            }
            hideChat(1)
            break
        case ".switching"+RR+LNumber,
            if(MU_Master){
                Switching = Sentence[2,string]:toNumber()
                if(Switching){
                    Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Switching Mode Engaged.")
                }else{
                    Speaker:printProper("[RLC Sapphire "+RR+" - "+LNumber+"]: Switching Mode Disengaged.")
                }
                hideChat(1)
            }
            break
        default,
            break
    }
}



if(AP&!Compressorallow){timer("Compressorallowrun",Compstarttime)}
if(clk("Compressorallowrun")){Compressorallow=1}
if(!AP&Compressorallow){Compressorallow=0}
if(EqualRes>0&!On){EqualRes--}
if(EqualRes>0&!On){Drain1=1}else{Drain1=0}
if(MainRes>0&!On){MainRes--}
if(MainRes>0&!On){Drain2=1}else{Drain2=0}
if(Compressortype==0){
    if((MainRes<120&Compressorallow) & !Compressing){
        Compressing = 1
        W:soundPlay(40,2,CompressorStartGE)
        timer("compdelay",1000)}
        elseif(clk("compdelay")){


stoptimer("compdelay")


        
    }elseif(!Compressorallow & Compressing){
        Compressing = 0
        W:soundPlay(8,2,CompressorStop)

        
    }elseif((MainRes>150) & Compressing){
        Compressing = 0
        W:soundPlay(8,2,CompressorStop)

        
    }
    if(Compressing){MainRes += 0.5+0.5*NumCompressors*CompRealnotch/CarCount2}
}
if(Compressortype==1){
    if((MainRes<120&Compressorallow) & !Compressing){
        Compressing = 1
        W:soundPlay(40,2,CompressorStartEMD)
    timer("compdelay",500)}
        elseif(clk("compdelay")){
W:soundPlay(8,0,CompressorRunning)





stoptimer("compdelay")

        
   }elseif(!Compressorallow & Compressing){
        Compressing = 0
        W:soundPlay(8,2,CompressorStop)

        
    }elseif((MainRes>150) & Compressing){
        Compressing = 0
        W:soundPlay(8,2,CompressorStop)
}
    if(Compressing){MainRes += 0.5+0.5*NumCompressors*CompRealnotch/CarCount2}
}
if(Compressortype==2){
    if((MainRes<120&Compressorallow) & !Compressing){
        Compressing = 1
        W:soundPlay(40,2,CompressorStartEMD)
    timer("compdelay",500)}
        elseif(clk("compdelay")){
soundVolume(800,2)





stoptimer("compdelay")

        
   }elseif(!Compressorallow & Compressing){
        Compressing = 0
        soundVolume(800,0.2)
        W:soundPlay(8,2,CompressorStop)
        
    }elseif((MainRes>150) & Compressing){
        Compressing = 0
        soundVolume(800,0.2)
        W:soundPlay(8,2,CompressorStop)
}
    if(Compressing){MainRes += 0.5+0.5*NumCompressors*CompRealnotch/CarCount2}
}
if(dupefinished()|first()){
if(Dev){hint("You are using Version "+Version+" of RLC Sapphire, This is a Combo Soldots sound and GSG sound chip",7)}
if(Dev){hint("Set Soldotsmegasound to 0 for gsg sounds if any sound/transition skiping happens",7)}
RealTemp=0
    if(Customlabeling){
    LNumber = Letters+randint(Minnumber,Maxnumber):toString() #Random Number Generator  
    RR = CutomRRname # RailRoad tag info}
}else{RR="" LNumber=""}
  if(Customlabeling){
print("[RLC Sapphire "+RR+"-"+LNumber+"]: Unit: "+RR+" "+LNumber+" "+Loco+" Is now done spawning.")}
else{
print("[RLC Sapphire]: Unit "+Loco+" Is now done spawning.")}
}

if(!AP){
if(EqualRes>0&!On){EqualRes-- Drain1=1}else{Drain1=0}
if(MainRes>0&!On){MainRes-- Drain2=1}else{Drain2=0}
if(RealTemp>32&!On){RealTemp-=0.2}
}
if(!On){timer("offrefresh",1000)}
